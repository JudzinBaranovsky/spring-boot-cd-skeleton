# How to build and run

## Prerequisites
1. Docker daemon and Docker Compose CLI.

## Building
1. Build, test, and analyse the code: `gradlew build`.
2. Build Docker images of all applications and push locally: `gradlew buildImages`.

## Running locally
### Basic setup
1. From the `local-infrastructure` folder
    1. Run `manage-app.ps1 start <case-name>`. For the `case-name`, see the design section below.
    2. Use `http://localhost:8080` to interact with the application.
    3. Attach to the exposed JMX port on `localhost:5006`. 

### Setup with logs and traces
0. **One-time setup**
   1. Create a `local-infrastructure/env/docker/.env` file with the following properties:
   ```
    KIBANA_SYSTEM_PASSWORD=<some password>
    ELASTIC_PASSWORD=<some password>
    LOGSTASH_INTERNAL_PASSWORD=<some password>
    FILEBEAT_INTERNAL_PASSWORD=<some password>
    BEATS_SYSTEM_PASSWORD=<some password>
    ELASTIC_VERSION=8.7.1
   ```
   2. Run `local-infrastructure/manage-env.ps1 setup` - this will deploy ElasticSearch 8 + Kibana 8 + Jaeger all-in-one for monitoring.
   3. Change the environment variables for `main-service` in `local-infrastructure/app/docker-compose.yml`:
      - `logging.file.enabled: true`
      - `management.tracing.enabled: true`
1. From the `local-infrastructure` folder
   1. Run `manage-env.ps1 start`.
   2. Run the applications (as in the basic setup).
   3. Use `http://localhost:5601` to search logs in Kibana (authorise as `elastic` with ELASTIC_PASSWORD).
   4. Use 'http:localhost:16686' to search traces in Jaeger.

### Other commands
1. `manage-env.ps1 recreate` - delete the application and monitoring containers, and create the monitoring containers from scratch
2. `manage-env.ps1 destroy` - delete the application and monitoring containers
3. `manage-env.ps1 stop` - stop the application and monitoring containers
4. `manage-app.ps1 stop` - stop the application container
5. `manage-app.ps1 destroy` - stop and remove the application container

# Running perf tests
- `./gradlew :perf-test:gatlingRun --simulation=<scenario>`
- here `scenario` is `org.bananalaba.perftest.CpuTest` or `org.bananalaba.perftest.MemoryTest`

# Perf stand design

## CPU load
- the API endpoint is `/api/v1/calculation?p=<integer>` in the `main-service`
- the load consists of
    - simulated worker
      - is configured with min and max delay
      - chooses a random delay between min and max
      - does busy waiting for the chosen delay (simple arithmetic in a loop)
    - data service
      - on each request, sleeps for a configurable delay between min/max
      - returns a random string
- what the endpoint does
    1. run a simulated worker task on the same thread
    2. then, submits another simulated worker in a separate thread
    3. then, makes a data-service request
    4. then, waits for the 2nd worker to complete
- available `case-name`s:
  - case-slow-async-task
  - case-slow-sync-task
  - case-slow-dependency-call

## Memory load
- the API endpoint is `/api/v1/blob/process-image?id=<integer>` in the `main-service`
- it simulates the processing of BLOBs downloaded from a fictitious external storage by the specified id
- each BLOB item has a binary payload and key-value metadata
- the endpoint
  - reaches out to an in-memory cache - indicates whether the item has changed or not
  - if the item is there, the item has not changed, return the metadata on it
  - otherwise, reach out to the repository responsible for the given collection (images, texts, or videos)
  - puts the item in the cache
  - returns the metadata
- each repository
  - has a Guava loading cache of a configurable max items number to hold
  - the loading logic is simulated by an item generator
- each item generator
  - consists of a BLOB generator
  - metadata generator
- metadata generator
  - has a set of predefined keys
  - the values for the keys are generated by picking a random value from the associated preconfigured list
- BLOB generator
  - generates a UUID4 string
  - performs N (configurable) iterations
  - repeats the current string M times (configurable)
  - appends it to the result
  - returns the byte array of the resulting string

# Open issues
1. In the `perf-test`, latest Gatling core (3.13.1 at the time) fails on Java 22+ due to module access issues, decided to stick with 3.8.3 to avoid that for now.
